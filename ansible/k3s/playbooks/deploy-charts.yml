---
- name: Check node roles
  hosts: all
  become: true
  tags: always
  tasks:
  
    - name: Build control and worker node lists
      ansible.builtin.set_fact:
        control_nodes: >-
          {{ ((groups['control'] | default([]) | map('extract', hostvars, 'ansible_host') | select('defined') | list)
              + (groups['control'] | default([]))) | unique }}
        worker_nodes: >-
          {{ ((groups['workers'] | default([]) | map('extract', hostvars, 'ansible_host') | select('defined') | list)
              + (groups['workers'] | default([]))) | unique }}

    - name: Determine host identity flags
      ansible.builtin.set_fact:
        host_identifier: "{{ ansible_host | default(inventory_hostname) }}"
        is_worker: "{{ (ansible_host | default(inventory_hostname)) in (worker_nodes | default([])) }}"
        is_control: "{{ (ansible_host | default(inventory_hostname)) in (control_nodes | default([])) }}"

    - name: Set skip-common flag for shared hosts
      ansible.builtin.set_fact:
        skip_common_roles: "{{ (is_worker | bool) and (is_control | bool) }}"

- name: Parse credentials for charts
  hosts: localhost
  connection: local
  gather_facts: false
  run_once: true
  tags:
    - always
  tasks:
    - name: Parse and distribute credentials
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../tasks/charts/parse_credentials.yml"

- name: Deploy Monitoring Charts
  hosts: control
  become: true
  tags:
    - monitoring-charts
  tasks:
    - name: Deploy monitoring charts
      ansible.builtin.include_tasks: 
        file: "{{ playbook_dir }}/../tasks/charts/deploy_monitoring.yml"
        apply:
          tags: monitoring-charts

- name: Deploy Miner Charts
  hosts: control
  become: true
  tags:
    - miner-charts
  tasks:
    - name: Deploy miner charts
      ansible.builtin.include_tasks: 
        file: "{{ playbook_dir }}/../tasks/charts/deploy_miner.yml"
        apply:
          tags: miner-charts

- name: Deploy Miner GPU Charts
  hosts: workers
  become: true
  strategy: free  # Allow workers to run independently without waiting
  serial: "{{ batch_size | default('100%') }}"  # Control batch size if needed
  tags:
    - miner-gpu-charts
  tasks:
    - name: Deploy miner-gpu charts
      ansible.builtin.include_tasks: 
        file: "{{ playbook_dir }}/../tasks/charts/deploy_miner_gpu.yml"
        apply:
          tags: miner-gpu-charts
