---
- name: Setup monitoring
  when: inventory_hostname in groups['control']
  block:
    - name: Add Prometheus Helm repository
      kubernetes.core.helm_repository:
        name: prometheus-community
        repo_url: https://prometheus-community.github.io/helm-charts

    - name: Add Metrics Server Helm repository
      kubernetes.core.helm_repository:
        name: metrics-server
        repo_url: https://kubernetes-sigs.github.io/metrics-server

    - name: Add k8s dashboard Helm repository
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: https://kubernetes.github.io/dashboard

    - name: Update helm
      ansible.builtin.command: helm repo update
      register: helm_repo_update_result
      changed_when: "'Update Complete' in helm_repo_update_result.stdout"
      failed_when: helm_repo_update_result.rc != 0
      
    - name: Install Prometheus
      shell: |
        helm upgrade --install prometheus prometheus-community/prometheus \
          --namespace monitoring \
          --create-namespace \
          --set server.persistentVolume.enabled=false \
          --set alertmanager.persistentVolume.enabled=false \
          --set prometheus-pushgateway.persistentVolume.enabled=false \
          --set prometheus-server.persistentVolume.enabled=false \
          --set alertmanager.persistence.enabled=false \
          --set server.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set alertmanager.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set pushgateway.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set kubeStateMetrics.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }}

    - name: Install kubernetes dashboard
      shell: |
        helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard \
          --create-namespace \
          --namespace kubernetes-dashboard \
          --set app.scheduling.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set auth.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set api.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set web.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set metricsScraper.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set kong.nodeSelector."kubernetes\.io/hostname"={{ inventory_hostname }} \
          --set persistence.enabled=false