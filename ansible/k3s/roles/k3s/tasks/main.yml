---
- name: k3s prereqs
  ansible.builtin.include_tasks: common.yml
  tags: k3s-prereqs

- name: Install k3s
  ansible.builtin.include_tasks: install.yml
  tags: k3s-install

- name: Setup k3s server
  ansible.builtin.include_tasks: setup_server.yml
  when: inventory_hostname in groups['control']
  tags: k3s-server

- name: Setup k3s agent
  ansible.builtin.include_tasks: setup_agent.yml
  when: inventory_hostname in groups['workers']
  tags: k3s-agent

- name: Setup k3s kubectl
  ansible.builtin.include_tasks: setup_kubectl.yml
  when: inventory_hostname in groups['control']
  tags: k3s-kubectl

- name: Add chutes labels to nodes
  kubernetes.core.k8s:
    state: present
    kind: Node
    name: "{{ inventory_hostname }}"
    definition:
      metadata:
        labels:
          chutes/external-ip: "{{ ansible_host }}"
    merge_type: strategic-merge
  delegate_to: "{{ groups['control'][0] }}"
  when: inventory_hostname in groups['workers']
