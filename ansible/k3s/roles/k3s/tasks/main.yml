---
- name: Install k3s
  ansible.builtin.include_tasks: install.yml
  tags: k3s-install

- name: Setup node
  ansible.builtin.include_tasks: setup_node.yml
  tags: k3s-node

- name: Setup k3s kubectl
  ansible.builtin.include_tasks: "{{ playbook_dir }}/../tasks/k8s/setup_kubectl.yml"
  tags: k3s-kubectl

- name: Setup namespaces
  ansible.builtin.include_tasks: setup_namespaces.yml
  tags: namespaces

- name: Add chutes labels to nodes
  block:
    - name: Add IP label
      kubernetes.core.k8s:
        state: present
        kind: Node
        name: "{{ inventory_hostname }}"
        context: "{{ inventory_hostname }}"
        definition:
          metadata:
            labels:
              chutes/external-ip: "{{ ansible_host }}"
        merge_type: strategic-merge
        
- name: Add worker labels to nodes
  when: inventory_hostname in groups['workers']
  block:
    - name: Add worker label
      kubernetes.core.k8s:
        state: present
        kind: Node
        name: "{{ inventory_hostname }}"
        context: "{{ inventory_hostname }}"
        definition:
          metadata:
            labels:
              chutes/worker: "true"
        merge_type: strategic-merge
      
