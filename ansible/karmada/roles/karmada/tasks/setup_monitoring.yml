---
- name: Monitoring setup
  tags: monitoring
  block:
    - name: Create temporary directory for monitoring charts
      ansible.builtin.file:
        path: /tmp/chutes-monitoring
        state: directory
        mode: "0755"

    - name: Copy monitoring charts from local directory
      ansible.builtin.copy:
        src: "{{ role_path }}/../../../../charts/chutes-monitoring/"
        dest: /tmp/chutes-monitoring/
        mode: preserve
      register: copy_charts_result
      changed_when: copy_charts_result.changed

    # Install monitoring on Karmada API Server context
    - name: Generate Monitoring API Server Helm values
      ansible.builtin.template:
        src: monitoring-apiserver-values.yaml.j2
        dest: /tmp/monitoring-apiserver-values.yaml
        mode: "0644"

    - name: Install or upgrade Monitoring on Karmada API Server context
      ansible.builtin.command: >
        helm upgrade --install monitoring /tmp/chutes-monitoring
        --kubeconfig={{ karmada_kubeconfig_temp_dir }}/karmada-apiserver
        --namespace {{ karmada_monitoring_namespace }}
        --create-namespace
        -f /tmp/monitoring-apiserver-values.yaml
      register: monitoring_apiserver_deployment
      changed_when: monitoring_apiserver_deployment.rc == 0

    - name: Get Karmada API Server token
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          KUBECONFIG={{ karmada_kubeconfig_temp_dir }}/karmada-apiserver \
          kubectl get secret -n {{ karmada_monitoring_namespace }} prometheus \
          -o jsonpath='{.data.token}' | base64 -d
        executable: /bin/bash
      register: api_token
      changed_when: false
      failed_when: api_token.rc != 0

    - name: Set the API token fact
      ansible.builtin.set_fact:
        api_server_token: "{{ api_token.stdout }}"

    # Install monitoring on Karmada host
    - name: Generate Monitoring Host Helm values
      ansible.builtin.template:
        src: monitoring-host-values.yaml.j2
        dest: /tmp/monitoring-host-values.yaml
        mode: "0644"

    - name: Install or upgrade Monitoring on Karmada host
      ansible.builtin.command: >
        helm upgrade --install monitoring /tmp/chutes-monitoring
        --namespace {{ karmada_monitoring_namespace }}
        --kube-context {{ inventory_hostname }}
        --create-namespace
        -f /tmp/monitoring-host-values.yaml
      register: monitoring_host_deployment
      changed_when: monitoring_host_deployment.rc == 0

    - name: Wait for Monitoring components to be ready on host
      ansible.builtin.command: >
        kubectl -n {{ karmada_monitoring_namespace }} wait --for=condition=Ready pod
        --selector="app.kubernetes.io/component=server,app.kubernetes.io/name=prometheus" --timeout=30s
      register: monitoring_wait
      changed_when: false
      retries: 5
      delay: 30
      until: monitoring_wait.rc == 0
      when:
        - monitoring_host_deployment is defined
        - monitoring_host_deployment.rc is defined
        - monitoring_host_deployment.rc == 0
