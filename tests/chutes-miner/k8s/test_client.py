import json
from chutes_miner.api.k8s.client import KubernetesMultiClusterClientManager
import pytest
from chutes_miner.api.k8s.config import KubeConfig
import yaml
from kubernetes import client

@pytest.fixture
def sample_kubeconfig():
    return {
        "kubeconfig": "apiVersion: v1\nkind: Config\nclusters:\n- cluster:\n    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUzTlRJM056a3lNell3SGhjTk1qVXdOekUzTVRrd056RTJXaGNOTXpVd056RTFNVGt3TnpFMgpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUzTlRJM056a3lNell3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFTOFdEM0ZkaStOQ0hXODBKZVpPcDZPNjF4KzlnUEtvUWU0cGRlUDkwK1cKdHZjMjg4ZFlOSWg5TnNpT0RvT1owU2hwQitYMTJXM0xBYWJLTzBPdWdoN01vMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVWJvcHQrMVNhZTN0YXZrek1XcGo0CndpYmU5Mm93Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQVA3SVZHVlRzaW94eURuamRaQmRIQitSdC8rc3BNNEIKSW9waEVlek94bjBqQWlCeVViVkFubzl2ZmRYb1FhNXU4ZUhwTGRNVkkycXBaNFdFdGJ3bVFzUmVUUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K\n    server: https://127.0.0.1:6443\n  name: chutes-miner-gpu-0\ncontexts:\n- context:\n    cluster: chutes-miner-gpu-0\n    user: chutes-miner-gpu-0\n    namespace: default\n  name: chutes-miner-gpu-0\ncurrent-context: miner\nusers:\n- name: chutes-miner-gpu-0\n  user:\n    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNaekNDQWd5Z0F3SUJBZ0lSQUtzQTdSTytsb0ptSnZFdS9UMHREc293Q2dZSUtvWkl6ajBFQXdJd0l6RWgKTUI4R0ExVUVBd3dZYXpOekxXTnNhV1Z1ZEMxallVQXhOelV5TnpjNU1qTTJNQjRYRFRJMU1EY3hOekU1TWpZdwpObG9YRFRJMk1EY3hOekU1TWpZd05sb3dJVEVQTUEwR0ExVUVDaE1HWTJoMWRHVnpNUTR3REFZRFZRUURFd1Z0CmFXNWxjakNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFOc3ZZSmNQQzlMb1QwRDMKTjZWZkVMaTNXSU5kQlVra21NYVJhdXpBZmQzTzh3ZUtQcTVvOG1sWWd6cmN4ZXU3SUxtZzJ1NEkxc2hFQ1VQYgptTUdKNDJRNmpocVd4TmhJRW5HVnlKODNKdnFUZ0ZqazFFT2hsYnBRcE1KOWpvR3dDY2wzWXZybmp5ZVJzRHA2CmZQK2Q3bTl1bWJtRXRDN0RuWnJBMGwxTFhvd0lMc3htR2ozOVhDQ1NNckMvZ1U2dHUzcWRvaXFGN3MzNlJxakQKSXNXWldEVXFRamZtQ1owcldOMS94Rlhnb1VhT1c0SGIyMHVvL3djbG54elFBdjdMcktwOWsrb3NpOEVwTWFoVgpSQWJERXVjWVQyUGVSQjRjekNRSXhka0dvM1lsQnJxY2N3TVl0WWkvNU9RN0V1Wk96OWtXN3VwN21GK1gzN2hDCmRnaG51NHNDQXdFQUFhTllNRll3RXdZRFZSMGxCQXd3Q2dZSUt3WUJCUVVIQXdJd0RBWURWUjBUQVFIL0JBSXcKQURBZkJnTlZIU01FR0RBV2dCVHJKVk5NWWQzbTE3M2xXK1VZaFV3UzdqM2hmekFRQmdOVkhSRUVDVEFIZ2dWdAphVzVsY2pBS0JnZ3Foa2pPUFFRREFnTkpBREJHQWlFQW9QUVhQN1crVGdJZkl4ak5JdHZLWmRLbDV6ZTVRcmlLCjNBMUpENjgxWGtFQ0lRREN6aW9WamtxODlIdG03R3ZTbGlzUWdCMmtnbEQxUzdiYXRBeXRGbitZM3c9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==\n    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBMnk5Z2x3OEwwdWhQUVBjM3BWOFF1TGRZZzEwRlNTU1l4cEZxN01COTNjN3pCNG8rCnJtanlhVmlET3R6RjY3c2d1YURhN2dqV3lFUUpROXVZd1lualpEcU9HcGJFMkVnU2NaWEluemNtK3BPQVdPVFUKUTZHVnVsQ2t3bjJPZ2JBSnlYZGkrdWVQSjVHd09ucDgvNTN1YjI2WnVZUzBMc09kbXNEU1hVdGVqQWd1ekdZYQpQZjFjSUpJeXNMK0JUcTI3ZXAyaUtvWHV6ZnBHcU1NaXhabFlOU3BDTitZSm5TdFkzWC9FVmVDaFJvNWJnZHZiClM2ai9CeVdmSE5BQy9zdXNxbjJUNml5THdTa3hxRlZFQnNNUzV4aFBZOTVFSGh6TUpBakYyUWFqZGlVR3VweHoKQXhpMWlML2s1RHNTNWs3UDJSYnU2bnVZWDVmZnVFSjJDR2U3aXdJREFRQUJBb0lCQUNqeU1kWW1ibXdKRC8wdgo4Y3BIOXlTNnc2Tk90bFVTckNPME9NaGZzV1BGYkd0RkxTNkIxbjlObEw1alRlb2F2Q05SWkhUQlcvWnZsMWVBCjU0bUlTOTJHZnRPQ3hPVXVtWnQwZ3RVVGhZbWNFb2NJd0lxZDNnMi9VUGd3WW5YaHdBSk45a1N2QzNRMTZEa1UKZHROOTJuUWdza0VSQkdRVUVSWSszVTJtYmRRMHZuWHNwRUJsRVd2YVVuSWxGajRFZUx3a1BsK0dlMWNRWUlMWApmcVk1d1c0OENtSG1kaVVjZWdvQWhyN0YrL3NON1dzdkdEVXBLU3JtbGxhZ01lc3ZPdm44WlJGdnF4b1hvSEZWCkJjdkx0SXgzQVlXc0d6dWRmait3VjUzZ0NWOGZMc0wyT3BLeWE5elVGaUdiT0dBUHdLV3REUUx3MHJxL3FpMXgKdGRuZWtTa0NnWUVBM3ROLzY1anJCN1BqZ2hzQVhjQUQwYUllTlFqanoxdDNZNW5sTzdKaThzbFRyNE5UOVRJdwp6N2JieTRYblRySklieEJ5bm9nQnNFUHVIcENnNGhZTFJldGQ1dUlmSk0wN0dWMUFMMlhjSG9hbjZMNHpLSzhMCm9QN3FTaVRmeHFScy8xUVVzblprSjUrVlVlR0ZJdkVtOFg4c2QwVkcyUmZDdjZqQlcxSjdhQVVDZ1lFQSs5RWEKL3pocXd2b1VubzBFSE5KMXFpN2doV21oRHlzQlcrUlFwVnh1TmorcXBqeUh0UjZVN20yemszU3YyYTFqU3NsRApoMUxibUxMZTBYYm9WazRlbzVHb1o1ZmE5TW90dThTUEptS0VkalBwQjg1NHJLaXpVK1VFa2Nld1hHaDlGaGplCi8zMXc4TjlHNkhSMEI1blJqdjA2aEZ2V0xiYjdPWUZ4MnRienVrOENnWUJWU1NaaENucUt6RE44RE5HckVGOWwKMFdNMmNWeWdkU1hSSFlvN3V4OWNSZXFkOXVvZm8wSkRmbjNKL0VwNE9JeTQxZGJKRHMxMnBjbHlNWEVpbDhWZwowYUZ6U1lFYUdPTlI1ZnMzS1FtRE5ZNzI2ald5a0swbXhlcnV6Z1pJaFk2aWU1QWdibWdQTW1sNG1aVFh0dTFzCjZYd2Zlb2lQZHlTM0x1UXpDL0xuOFFLQmdGVE1ESkJIT2tSZ0hGTnIzeWVwZzNBRWl4ekIvamR5WHVuSHo1UnYKdExsVjVTeEhrOWRjN2dBQU53bC9zTHZYbEdrWnIwREJtU3NwaUxqMmxyU0JaL1hpMWRmVW5pbnliMFljb2F2bQpYdjdDNmtUenRWVkhGZVE1YWJtQmloVUVKcU1yU3VTMEpEVW9xdU1hVy93M1F3Y29wT3p2VkFkZTUraHNlNSthCjVNWW5Bb0dCQUtpOWN0dHkrdkl6UlFkZElDUmlReFhZakhuRjBQRFhrZmdVK3ZqekprOU0xZEM1SzlheVgyQXgKQThjOWtOL0tqODU3QllVMTJvdG9SOFQxaE1mcHFvK2VOcnUxeFF0SUFjZkJpUVp4V3l6enpYYjI2MHJJSUlhcgpGTmNvbGV6bUYyT0pHbGlzNWtvOGZLYmp0L3ljZFp3UTZ1bXN1ZlIxVFM3c3FpMGhVTHF5Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==\n"
    }

def test_get_core_client(sample_kubeconfig):
    
    # json_data = json.loads(sample_kubeconfig)
    kubeconfig_dict = yaml.safe_load(sample_kubeconfig["kubeconfig"])
    kubeconfig = KubeConfig.from_dict(kubeconfig_dict)

    manager = KubernetesMultiClusterClientManager()

    _client = manager.get_core_client("chutes-miner-gpu-0", kubeconfig)

    assert type(_client) == client.CoreV1Api
