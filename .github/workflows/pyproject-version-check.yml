name: Version Bump Check

on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'

jobs:
  version-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch main
        run: git fetch origin main

      - name: Check module version bumps
        run: |
          set -e
          SRC_DIR="src"
          FAILED=""
          FAIL_MSG=""

          # Get version for a module: VERSION file first, else pyproject.toml [tool.poetry] version
          get_version() {
            local dir="$1"
            if [ -f "$dir/VERSION" ]; then
              head -1 "$dir/VERSION" | tr -d '\n\r \t'
            elif [ -f "$dir/pyproject.toml" ]; then
              sed -n '/^\[tool\.poetry\]/,/^\[/p' "$dir/pyproject.toml" | grep '^version = ' | head -1 | sed -E 's/^version = ["'\'']([^"'\'']+)["'\''].*/\1/'
            else
              echo ""
            fi
          }

          # Compare two semver strings: print "ok" if second > first, else "fail"
          version_gt() {
            local main_ver="$1"
            local pr_ver="$2"
            [ -z "$pr_ver" ] && { echo "fail"; return; }
            [ -z "$main_ver" ] && main_ver="0.0.0"
            HIGHER=$(printf '%s\n%s\n' "$main_ver" "$pr_ver" | sort -V | tail -n1)
            if [ "$HIGHER" = "$pr_ver" ] && [ "$main_ver" != "$pr_ver" ]; then
              echo "ok"
            else
              echo "fail"
            fi
          }

          # Top-level modules under src/
          MODULES=$(find "$SRC_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort)

          # Changed paths in this PR (files changed vs main)
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD -- "$SRC_DIR/" || true)
          CHANGED_MODULES=$(echo "$CHANGED_FILES" | awk -F/ -v n=2 'NF>=n {print $n}' | sort -u)

          if [ -z "$CHANGED_MODULES" ]; then
            echo "No modules under src/ were changed. Nothing to verify."
            exit 0
          fi

          echo "Modules with changes: $CHANGED_MODULES"
          echo ""

          for MODULE in $CHANGED_MODULES; do
            MODULE_DIR="$SRC_DIR/$MODULE"
            [ ! -d "$MODULE_DIR" ] && continue

            # Get version on main
            MAIN_VERSION=$(git show origin/main:"$MODULE_DIR/VERSION" 2>/dev/null | head -1 | tr -d '\n\r \t' || true)
            if [ -z "$MAIN_VERSION" ]; then
              MAIN_VERSION=$(git show origin/main:"$MODULE_DIR/pyproject.toml" 2>/dev/null | sed -n '/^\[tool\.poetry\]/,/^\[/p' | grep '^version = ' | head -1 | sed -E 's/^version = ["'\'']([^"'\'']+)["'\''].*/\1/' || true)
            fi
            [ -z "$MAIN_VERSION" ] && MAIN_VERSION="0.0.0"

            # Get version in PR branch (current checkout)
            PR_VERSION=$(get_version "$MODULE_DIR")

            GT=$(version_gt "$MAIN_VERSION" "$PR_VERSION")
            if [ "$GT" = "ok" ]; then
              echo "✅ $MODULE: $MAIN_VERSION → $PR_VERSION (bumped)"
            else
              if [ -z "$PR_VERSION" ]; then
                FAIL_MSG="${FAIL_MSG}- **$MODULE**: No VERSION file or version in pyproject.toml. Add a VERSION file or set \`version\` under [tool.poetry] and ensure it is higher than main ($MAIN_VERSION).\n"
              else
                FAIL_MSG="${FAIL_MSG}- **$MODULE**: VERSION must be higher than on main. main=$MAIN_VERSION, PR=$PR_VERSION.\n"
              fi
              FAILED=1
            fi
          done

          if [ -n "$FAILED" ]; then
            echo ""
            echo "::error::One or more modules with changes do not have a version bump."
            echo -e "$FAIL_MSG"
            exit 1
          fi

      - name: Check VERSION / pyproject.toml sync
        run: |
          set -e
          SRC_DIR="src"
          SYNC_FAILED=""
          SYNC_MSG=""

          # Get version from VERSION file only
          get_version_file() {
            local dir="$1"
            if [ -f "$dir/VERSION" ]; then
              head -1 "$dir/VERSION" | tr -d '\n\r \t'
            else
              echo ""
            fi
          }

          # Get version from pyproject.toml [tool.poetry] only
          get_pyproject_version() {
            local dir="$1"
            if [ -f "$dir/pyproject.toml" ]; then
              sed -n '/^\[tool\.poetry\]/,/^\[/p' "$dir/pyproject.toml" | grep '^version = ' | head -1 | sed -E 's/^version = ["'\'']([^"'\'']+)["'\''].*/\1/' | tr -d '\n\r \t'
            else
              echo ""
            fi
          }

          for dir_path in "$SRC_DIR"/*/; do
            [ -d "$dir_path" ] || continue
            MODULE=$(basename "$dir_path")
            VERSION_FILE="$dir_path/VERSION"
            PYPROJECT="$dir_path/pyproject.toml"
            [ -f "$VERSION_FILE" ] || continue
            [ -f "$PYPROJECT" ] || continue

            VERSION_VAL=$(get_version_file "$dir_path")
            PYPROJECT_VAL=$(get_pyproject_version "$dir_path")

            if [ "$VERSION_VAL" != "$PYPROJECT_VAL" ]; then
              SYNC_MSG="${SYNC_MSG}- **$MODULE**: VERSION has \`${VERSION_VAL}\` but pyproject.toml has \`version = \"${PYPROJECT_VAL}\"\`. Sync them so built packages have the correct version.\n"
              SYNC_FAILED=1
            else
              echo "✅ $MODULE: VERSION and pyproject.toml both $VERSION_VAL"
            fi
          done

          if [ -n "$SYNC_FAILED" ]; then
            echo ""
            echo "::error::VERSION file and pyproject.toml must match for each package under src/ before merging to main."
            echo -e "$SYNC_MSG"
            exit 1
          fi
